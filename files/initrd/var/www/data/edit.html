<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Config Editor</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="bootstrap.bundle.min.js"></script>
    <style>
        .iframe-container {
            position: relative;
            width: 100%;
            height: 750px;
        }
        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .iframe-container iframe.active {
            display: block;
        }
        #sysinfo-container {
            max-height: 750px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <main class="p-0 base">
        <div class="container">
            <div class="row">
                <div class="col-md-4 user-card" style="width: 30%;">
                    <div class="header-banner" style="background-image: url('./arc_loader.png'); background-size: cover; background-position: center;">
                    </div>

                    <div class="header-top">
                        <div class="header-text">
                            <span class="header-username">Config Editor</span>
                        </div>
                        <p class="text-muted"><small id="page-title">Edit Configuration</small></p>
                        <p class="text-muted"><small id="server-ip">Loading IP...</small></p>
                    </div>
                    <div class="body-wrapper">
                        <div id="navigation-container"></div>
                    </div>
                </div>
                <div class="col-md-8 user-card2" style="width: 70%;">
                    <div class="body-wrapper">
                        <form id="config-form">
                            <div class="mb-3">
                                <label for="cpufreqscaling" class="form-label">CPU Frequency Scaling</label>
                                <select id="cpufreqscaling" class="form-select">
                                    <option value="schedutil">schedutil</option>
                                    <option value="performance">performance</option>
                                    <option value="powersave">powersave</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="kernel" class="form-label">Kernel</label>
                                <select id="kernel" class="form-select">
                                    <option value="official">official</option>
                                    <option value="custom">custom</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="timezone" class="form-label">Timezone</label>
                                <input type="text" id="timezone" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="region" class="form-label">Region</label>
                                <input type="text" id="region" class="form-control">
                            </div>
                            <button type="button" id="save-button" class="btn btn-primary mt-3">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchConfig();

            document.getElementById('save-button').addEventListener('click', function() {
                saveConfig();
            });
        });

        function fetchConfig() {
            fetch('/cgi-bin/read-config.cgi')
                .then(response => response.text())
                .then(data => {
                    const config = parseYAML(data);
                    document.getElementById('cpufreqscaling').value = config.addons.cpufreqscaling;
                    document.getElementById('kernel').value = config.kernel;
                    document.getElementById('timezone').value = config.time.timezone;
                    document.getElementById('region').value = config.time.region;
                })
                .catch(error => {
                    console.error('Error fetching config:', error);
                });
        }

        function saveConfig() {
            const config = {
                addons: {
                    cpufreqscaling: document.getElementById('cpufreqscaling').value
                },
                kernel: document.getElementById('kernel').value,
                time: {
                    timezone: document.getElementById('timezone').value,
                    region: document.getElementById('region').value
                }
            };
            const configContent = YAML.stringify(config);
            fetch('/cgi-bin/save-config.cgi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `config=${encodeURIComponent(configContent)}`
            })
            .then(response => response.text())
            .then(data => {
                alert('Configuration saved successfully');
            })
            .catch(error => {
                console.error('Error saving config:', error);
            });
        }

        function parseYAML(yaml) {
            // Simple YAML parser for demonstration purposes
            const lines = yaml.split('\n');
            const result = {};
            let currentSection = result;
            lines.forEach(line => {
                if (line.trim() === '') return;
                if (line.startsWith('  ')) {
                    const [key, value] = line.trim().split(': ');
                    currentSection[key] = value;
                } else {
                    const [key, value] = line.split(': ');
                    if (value === undefined) {
                        result[key] = {};
                        currentSection = result[key];
                    } else {
                        result[key] = value;
                    }
                }
            });
            return result;
        }
    </script>
</body>
</html>